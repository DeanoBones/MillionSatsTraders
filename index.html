<script>
  // Trading competition scores
  const scores = {
    Shandalf: 0,
    Bucky: 0,
    Hawk: 0
  };
  const lastWeeksWinner = "None";
  const API_URL = 'https://satoshi-millionaire-backend.onrender.com/api';
  const currentWeek = getCurrentWeek();

  function getCurrentWeek() {
    const now = new Date();
    const startOfYear = new Date(now.getFullYear(), 0, 1);
    const weekNumber = Math.ceil((((now - startOfYear) / 86400000) + startOfYear.getDay() + 1) / 7);
    return `${now.getFullYear()}-W${weekNumber.toString().padStart(2, '0')}`;
  }

  function showMessage(elementId, message) {
    console.log(`Showing message for ${elementId}: ${message}`);
    const messageEl = document.getElementById(elementId);
    messageEl.textContent = message;
    messageEl.style.display = message ? 'block' : 'none';
  }

  document.getElementById('betting-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const userName = document.getElementById('user-name').value.trim();
    const betTrader = document.getElementById('bet-trader').value;

    showMessage('bet-message', 'Submitting bet...');

    try {
      const response = await fetch(`${API_URL}/bets`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ user_name: userName, trader: betTrader, week: currentWeek })
      });
      const data = await response.json();
      showMessage('bet-message', response.ok ? 'Bet placed successfully!' : (data.error || 'Error placing bet.'));
      if (response.ok) {
        document.getElementById('betting-form').reset();
        renderBettingLeaderboard();
      }
    } catch (error) {
      showMessage('bet-message', 'Server is waking up. Please try again in a few seconds.');
    }
  });

  document.getElementById('admin-login-btn').addEventListener('click', () => {
    console.log('Admin login button clicked');
    document.getElementById('admin-login-section').classList.add('active');
    document.getElementById('admin-login-btn').style.display = 'none';
    document.getElementById('admin-login-password').focus();
  });

  document.getElementById('admin-login-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const password = document.getElementById('admin-login-password').value.trim();
    const submitButton = document.getElementById('admin-login-form').querySelector('button');

    if (!password) {
      showMessage('admin-login-message', 'Please enter a password.');
      return;
    }

    submitButton.disabled = true;
    showMessage('admin-login-message', 'Verifying password...');
    console.log('Sending password verification request');

    try {
      const response = await fetch(`${API_URL}/admin/verify-password`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ password })
      });
      console.log(`Verify password response status: ${response.status}`);
      const data = await response.json();
      console.log('Verify password response data:', data);

      if (response.status === 401) {
        showMessage('admin-login-message', 'Incorrect password.');
        submitButton.disabled = false;
        return;
      }
      if (response.status === 400) {
        showMessage('admin-login-message', data.error || 'Invalid request. Please try again.');
        submitButton.disabled = false;
        return;
      }
      if (response.status === 500) {
        showMessage('admin-login-message', 'Server error. Please try again later.');
        submitButton.disabled = false;
        return;
      }
      if (!response.ok) {
        showMessage('admin-login-message', data.error || 'Password verification failed.');
        submitButton.disabled = false;
        return;
      }

      console.log('Password verified, showing admin section');
      document.getElementById('admin-login-section').classList.remove('active');
      document.getElementById('admin-section').style.display = 'block';
      document.getElementById('admin-login-password').value = '';
      showMessage('admin-login-message', '');
      submitButton.disabled = false;
    } catch (error) {
      console.error('Verify password error:', error);
      showMessage('admin-login-message', error.message.includes('Failed to fetch') ? 'Server is waking up. Try again in 30 seconds.' : `Error: ${error.message}`);
      submitButton.disabled = false;
    }
  });

  document.getElementById('admin-winner-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const winner = document.getElementById('actual-winner').value;
    const submitButton = document.getElementById('admin-winner-form').querySelector('button');

    submitButton.disabled = true;
    showMessage('admin-message', 'Setting winner...');
    console.log(`Sending winner request: winner=${winner}, week=${currentWeek}`);

    try {
      const response = await fetch(`${API_URL}/admin/set-winner`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ winner, week: currentWeek })
      });
      console.log(`Winner response status: ${response.status}`);
      const data = await response.json();
      console.log('Winner response data:', data);

      if (!response.ok) {
        showMessage('admin-message', data.error || 'Error setting winner.');
        submitButton.disabled = false;
        return;
      }

      showMessage('admin-message', 'Winner set and scores updated!');
      document.getElementById('last-winner-name').textContent = winner;
      document.getElementById('admin-winner-form').reset();
      document.getElementById('admin-section').style.display = 'none';
      document.getElementById('admin-login-btn').style.display = 'block';
      renderBettingLeaderboard();
      submitButton.disabled = false;
    } catch (error) {
      console.error('Winner error:', error);
      showMessage('admin-message', error.message.includes('Failed to fetch') ? 'Server is waking up. Try again in 30 seconds.' : `Error: ${error.message}`);
      submitButton.disabled = false;
    }
  });

  async function renderBettingLeaderboard() {
    const container = document.getElementById('betting-leaderboard-cards');
    container.innerHTML = '<p>Loading leaderboard...</p>';
    try {
      const response = await fetch(`${API_URL}/scores`);
      const scores = await response.json();
      container.innerHTML = '';
      scores.forEach(({ user_name, score }, index) => {
        const rank = index + 1;
        const card = document.createElement('div');
        card.className = `card rank-${rank}`;
        card.innerHTML = `
          <h4>${user_name}</h4>
          <p>Points: ${score}</p>
        `;
        container.appendChild(card);
      });
    } catch (error) {
      container.innerHTML = '<p>Server is waking up. Refresh in a few seconds.</p>';
    }
  }

  function renderLeaderboard() {
    const container = document.getElementById('leaderboard-cards');
    const sortedScores = Object.entries(scores).sort((a, b) => b[1] - a[1]);
    container.innerHTML = '';
    sortedScores.forEach(([name, points], index) => {
      const rank = index + 1;
      const card = document.createElement('div');
      card.className = `card rank-${rank}`;
      card.innerHTML = `
        <h4>${name}</h4>
        <p>Points: ${points}</p>
      `;
      container.appendChild(card);
    });
  }

  function displayLastWinner() {
    document.getElementById('last-winner-name').textContent = lastWeeksWinner;
  }

  function toggleRules() {
    const rules = document.getElementById('rules');
    const button = document.querySelector('.toggle-rules');
    if (rules.classList.contains('active')) {
      rules.classList.remove('active');
      button.textContent = 'Show Rules';
    } else {
      rules.classList.add('active');
      button.textContent = 'Hide Rules';
    }
  }

  async function fetchPrizePool() {
    try {
      const response = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=bitcoin&vs_currencies=gbp');
      const data = await response.json();
      const btcPrice = data.bitcoin.gbp;
      const sats = 1000000;
      const btcAmount = sats / 100000000;
      const gbpAmount = (btcAmount * btcPrice).toFixed(2);
      document.getElementById('prize-gbp').textContent = `~£${gbpAmount}`;
    } catch (error) {
      document.getElementById('prize-gbp').textContent = '~£7.50 (API Error)';
    }
  }

  function updateCountdown() {
    const endDate = new Date('2025-12-20T23:59:00Z').getTime();
    const now = new Date().getTime();
    const timeLeft = endDate - now;

    if (timeLeft <= 0) {
      document.getElementById('countdown-timer').textContent = 'Competition Ended';
      return;
    }

    const days = Math.floor(timeLeft / (1000 * 60 * 60 * 24));
    const hours = Math.floor((timeLeft % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
    const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
    const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);

    document.getElementById('countdown-timer').textContent = `${days} days, ${hours} hours, ${minutes} minutes, ${seconds} seconds`;
  }

  renderLeaderboard();
  fetchPrizePool();
  displayLastWinner();
  updateCountdown();
  setInterval(updateCountdown, 1000);
  renderBettingLeaderboard();
</script>